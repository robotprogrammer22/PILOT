/*
 * Map/AstroMap.js
 *
 * This class wraps an OpenLayers map with Astro-specific functionality.
 *
 * Dependencies: OpenLayers.js, AstroGeometry.js, AstroVector.js, AstroBoundingBox.js, AstroControls.js
 *//*
 * Constructor: Initializes map.
 *
 * Parameters: mapSettings         - hash of map initialization settings. If null, uses sensible defaults
 *             controlSettings     - hash of map control settings. If null, uses sensible defaults
 *             consoleSettings     - hash of console settings. If null, uses sensible defaults
 *             boundingBoxSettings - hash of bounding box settings. If null, uses sensible defaults
 *
 * Please refer to AstroControls.js, AstroConsole.js, and AstroBoundingBox.js for details on valid options
 * that can be passed in.
 *
 * The following map options may be set:
 *   mapDiv                       - the id (string) of the div to hold the OL map. Default: 'map'
 *   target                       - the target name. Default: 'mars'
 *   projection                   - the default map projection (string). Choices: 'cylindrical', 'north-polar stereographic',
 *                                  'south-polar stereographic'. Default: 'cylindrical'
 *   vectorLayerName              - the name for the vector feature layer to appear in the layer switcher. Default: 'Vectors'
 *   showNomenclature             - boolean indicating whether or not to load nomenclature layer (if available). Default: false
 *   datelineWrap                 - boolean indicating whether or not to wrap the map at the dateline. Default: true
 *   defaultZoomLevel             - number for default zoom level. Default: 3
 *   defaultCenterLat             - default center latitude of the map. Default: 0
 *   defaultCenterLon             - default center longitude of the map. Default: 180
 *   projectionSwitchTrigger      - callback function for map projection switches. Default: empty function
 *   imagePath                    - path to the images directory, be sure to include the trailing slash. Required.
 */function AstroMap(e,t,n,r){this.map=null,this.mapSettings=e,this.controlSettings=t,this.consoleSettings=n,this.boundingBoxSettings=r,this.imagePath=null,this.controls=null,this.console=null,this.baseLayerGroup=null,this.overLayerGroup=null,this.mapOverlay=null,this.boundingBoxSource=null,this.boundingBoxLayer=null,this.boundingBoxDrawer=null,this.vectorSource=null,this.vectorLayer=null,this.poiSource=null,this.poiLayer=null,this.imageSource=null,this.imageLayer=null,this.dummyLayer=null,this.homeLonLat=null,this.mapsLoaded=!1,this.hasNorthPolar=!1,this.hasSouthPolar=!1,this.nomenWFSURL=null,this.longitudeDirection="PositiveEast",this.longitudeDomain="360",this.latitudeType="Planetocentric",this.displayProjection="EPSG:4326",this.fullBoundingBox=null,this.aAxisRadius=0,this.bAxisRadius=0,this.cAxisRadius=0,this.mapDiv="map",this.target="mars",this.projection="cylindrical",this.currentProj="EPSG:4326",this.vectorLayerName="Vectors",this.showNomenclature=!1,this.datelineWrap=!0,this.deepZoom=!1,this.defaultZoomLevel=3,this.defaultCenterLat=0,this.defaultCenterLon=180,this.projectionSwitchTrigger=function(){},this.init()}function astroConsoleHistoryPrev(){}function astroConsoleHistoryNext(){}function AstroConsole(e,t){this.astroMap=e,this.target="Mars",this.targetInfo=!1,this.projButtons=!1,this.lonLatSelects=!1,this.mouseLonLat=!1,this.featureFinder=!1,this.keyColors=["blue","green","purple","aqua","lime","olive","teal"],this.key=new Array,this.imagePath=this.astroMap.imagePath,this.targetInfoDiv="astroConsoleTargetInfo",this.projButtonsDiv="astroConsoleProjectionButtons",this.lonLatSelectsDiv="astroConsoleLonLatSelects",this.keyDiv="astroConsoleKey",this.featureFinderDiv="astroFeatureFinder",this.targetImgId="astroConsoleTargetImage",this.northPoleImgId="astroProjectionNorthPole",this.cylindricalImgId="astroProjectionCylindrical",this.southPoleImgId="astroProjectionSouthPole",this.lonDirSelectId="astroConsoleLonDirSelect",this.lonDomSelectId="astroConsoleLonDomSelect",this.latTypeSelectId="astroConsoleLatTypeSelect",this.mouseLonLatDiv="astroConsoleLonLat",this.featureTypeSelectId="astroFeatureType",this.featureNameSelectId="astroFeatureName",t&&(t.target&&(this.target=t.target),t.targetInfo&&(this.targetInfo=!0),t.projButtons&&(this.projButtons=!0),t.lonLatSelects&&(this.lonLatSelects=!0),t.featureFinder&&(this.featureFinder=!0),t.mouseLonLat&&(this.mouseLonLat=!0),t.targetInfoDiv&&(this.targetInfoDiv=t.targetInfoDiv),t.projButtonsDiv&&(this.projButtonsDiv=t.projButtonsDiv),t.lonLatSelectsDiv&&(this.lonLatSelectsDiv=t.lonLatSelectsDiv),t.keyDiv&&(this.keyDiv=t.keyDiv),t.featureFinderDiv&&(this.featureFinderDiv=t.featureFinderDiv)),this.targetInfo&&this.targetInfoSetup(),this.mouseLonLat&&this.mouseLonLatSetup(),this.projButtons&&this.projButtonsSetup(),this.lonLatSelects&&this.lonLatSelectsSetup(null,null),this.featureFinder&&this.featureFinderSetup()}function AstroVector(e,t){this.astroMap=e,this.layer=t,this.storedVectors=[],this.styles=[],this.selectStyle=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 128, 0, 0.2)"}),stroke:new ol.style.Stroke({color:"#ff8000",width:2})}),this.savedIndex=-1}function AstroBoundingBox(e,t,n){this.astroMap=e,this.layer=t,this.savedIndex=-1,this.formIdWKT="astroBBWKT",this.formIdDatelineWKT="astroBBDatelineWKT",this.formIdTopLeftLon="astroBBTopLeftLon",this.formIdTopLeftLat="astroBBTopLeftLat",this.formIdBotRightLon="astroBBBotRightLon",this.formIdBotRightLat="astroBBBotRightLat",this.formIdCenterpoint="astroBBCenterPoint",this.formIdCenterLon="astroBBCenterLon",this.formIdCenterLat="astroBBCenterLat",this.formIdLength="astroBBLength",this.centerPoint=null,this.boundingBoxRemoveTrigger=function(){},this.boundingBoxFeatureSearchResultHandler=function(){},n&&(n.formIdWKT&&(this.formIdWKT=n.formIdWKT),n.formIdDatelineWKT&&(this.formIdDatelineWKT=n.formIdDatelineWKT),n.formIdTopLeftLon&&(this.formIdTopLeftLon=n.formIdTopLeftLon),n.formIdTopLeftLat&&(this.formIdTopLeftLat=n.formIdTopLeftLat),n.formIdBotRightLon&&(this.formIdBotRightLon=n.formIdBotRightLon),n.formIdBotRightLat&&(this.formIdBotRightLat=n.formIdBotRightLat),n.boundingBoxRemoveTrigger&&(this.boundingBoxRemoveTrigger=n.boundingBoxRemoveTrigger),n.boundingBoxFeatureSearchResultHandler&&(this.boundingBoxFeatureSearchResultHandler=n.boundingBoxFeatureSearchResultHandler))}function AstroPoi(e,t){this.astroMap=e,this.layer=t,this.storedPois=[],this.styles=[],this.selectStyle=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 128, 0, 0.2)"}),stroke:new ol.style.Stroke({color:"#ff8000",width:2})}),this.savedIndex=-1}function AstroControls(e,t){this.astroMap=e,this.controlSettings=t,this.buttons=[],this.buttonTop=85,this.buttonMargin=30,this.imagePath=this.astroMap.imagePath,this.layersWithSliders=[],this.mouseLonLatDiv="astroConsoleLonLat",this.scaleline=null,this.graticule=null,this.defaultLayerSwitcherBackgroundColor="#e3701a",this.defaultSelectStrokeColor="yellow",this.defaultSelectFillColor="#ff6600",this.zoomBarOn=!1,this.decimalPlaces=null,this.layerSwitcherOn=!1,this.graticuleOn=!1,this.featureSearchOn=!1,this.scaleLineOn=!1,this.overviewMapOn=!1,this.mousePositionOn=!1,this.dontConvertForm=!1,this.navButtonOn=!1,this.boundingBoxButtonOn=!1,this.circleButton=!1,this.lineButton=!1,this.pointButton=!1,this.measureButton=!1,this.resizeGeometryButton=!1,this.reshapeGeometryButton=!1,this.transformGeometryButton=!1,this.editCenterPointButton=!1,this.multiVectorEdit=!1,this.selectButtonoOn=!1,this.rubberBandSelectButton=!1,this.homeButtonOn=!1,this.expandButtonOn=!1,this.downloadButtonOn=!1,this.panel=null,this.defaultControl=null,this.controls={},this.draw=null,this.select=null,this.zoomEndHandler=function(){},this.selectHandler=function(){console.log("here")},this.boundingBoxDrawHandler=function(){},this.unselectHandler=function(){},this.editHandler=function(){},this.measureHandler=function(){},this.expandHandler=function(){},t&&(t.zoomBar&&(this.zoomBarOn=!0),t.layerSwitcher&&(this.layerSwitcherOn=!0),t.graticule&&(this.graticuleOn=!0),t.featureSearch&&(this.featureSearchOn=!0),t.scaleLine&&(this.scaleLineOn=!0),t.overviewMap&&(this.overviewMapOn=!0),t.mousePosition&&(this.mousePositionOn=!0),t.dontConvertForm&&(this.dontConvertForm=!0),t.navButton&&(this.navButtonOn=!0),t.boundingBoxDrawer&&(this.boundingBoxButtonOn=!0),t.circleDrawer&&(this.circleButton=!0),t.lineDrawer&&(this.lineButton=!0),t.pointDrawer&&(this.pointButton=!0),t.measureTool&&(this.measureButton=!0),t.resizeGeometryButton&&(this.resizeGeometryButton=!0),t.reshapeGeometryButton&&(this.reshapeGeometryButton=!0),t.transformGeometryButton&&(this.transformGeometryButton=!0),t.editCenterPointButton&&(this.editCenterPointButton=!0),t.selectButton&&(this.selectButtonOn=!0),t.rubberBandSelectButton&&(this.rubberBandSelectButton=!0),t.homeButton&&(this.homeButtonOn=!0),t.expandButton&&(this.expandButtonOn=!0),t.downloadButton&&(this.downloadButtonOn=!0),t.defaultControl&&(this.defaultControl=t.defaultControl),t.defaultLayerSwitcherBackgroundColor&&(this.defaultLayerSwitcherBackgroundColor=t.defaultLayerSwitcherBackgroundColor),t.defaultSelectStrokeColor&&(this.defaultSelectStrokeColor=t.defaultSelectStrokeColor),t.defaultSelectFillColor&&(this.defaultSelectFillColor=t.defaultSelectFillColor),t.boundingBoxDrawHandler&&(this.boundingBoxDrawHandler=t.boundingBoxDrawHandler),t.zoomEndHandler&&(this.zoomEndHandler=t.zoomEndHandler),t.selectHandler&&(this.selectHandler=t.selectHandler),t.unselectHandler&&(this.unselectHandler=t.unselectHandler),t.editHandler&&(this.editHandler=t.editHandler),t.measureHandler&&(this.measureHandler=t.measureHandler),t.expandHandler&&(this.expandHandler=t.expandHandler),t.decimalPlaces&&(this.decimalPlaces=t.decimalPlaces)),this.zoomBarOn&&this.zoomBar(),this.graticuleOn&&this.graticuleOption(),this.layerSwitcherOn&&this.layerSwitcher(),this.scaleLineOn&&this.scaleLine(),this.overviewMapOn&&this.overviewMap(),this.featureSearchOn&&this.featureSearch(),this.mousePositionOn&&this.mousePosition(),this.navButtonOn&&this.navigationButton(),this.homeButtonOn&&this.homeButton(),this.expandButtonOn&&this.expandButton(),this.selectButtonOn&&this.selectButton(),this.boundingBoxButtonOn&&this.boundingBoxButton(),this.downloadButtonOn&&this.downloadButton()}function AstroGeometry(){}AstroMap.prototype.destroy=function(){this.controls.deactivateButtons(),this.controls=null,this.map.setTarget(null),this.map=null},AstroMap.prototype.home=function(){if(this.homeLonLat){var e=this.map.getView();e.setCenter(this.homeLonLat)}},AstroMap.prototype.init=function(){this.mapSettings&&(this.mapSettings.mapDiv&&(this.mapDiv=this.mapSettings.mapDiv),this.mapSettings.target&&(this.target=this.mapSettings.target.toLowerCase()),this.mapSettings.projection&&(this.projection=this.mapSettings.projection),this.mapSettings.vectorLayerName&&(this.vectorLayerName=this.mapSettings.vectorLayerName),this.mapSettings.showNomenclature&&(this.showNomenclature=!0),this.mapSettings.datelineWrap||(this.datelineWrap=!1),this.deepZoom=!this.mapSettings.deepZoom||this.mapSettings.deepZoom=="false"?!1:!0,this.mapSettings.defaultZoomLevel&&(this.defaultZoomLevel=this.mapSettings.defaultZoomLevel),this.mapSettings.defaultCenterLat&&(this.defaultCenterLat=this.mapSettings.defaultCenterLat),this.mapSettings.defaultCenterLon&&(this.defaultCenterLon=this.mapSettings.defaultCenterLon),this.mapSettings.projectionSwitchTrigger&&(this.projectionSwitchTrigger=this.mapSettings.projectionSwitchTrigger),this.mapSettings.imagePath&&(this.imagePath=this.mapSettings.imagePath)),this.mapsLoaded=this.loadLayers(this.target,this.projection,this.showNomenclature,this.datelineWrap);var e=this.mapsLoaded[0].getLayers().getLength();e==0&&(this.mapsLoaded=this.loadDummyLayer());var t=this.projection=="cylindrical"?this.defaultZoomLevel:3,n=this.cAxisRadius,r=0,i=new ol.proj.Projection({code:"EPSG:32661",extent:[-2357032,-2357032,2357032,2357032],worldExtent:[0,60,360,90],units:"m"});ol.proj.addProjection(i),ol.proj.addCoordinateTransforms("EPSG:32661",i,function(e){return AstroGeometry.transformLatLonToPolarMeters(e,"north-polar stereographic",n)},function(e){return AstroGeometry.transformPolarMetersToLatLon(e,"north-polar stereographic",n)}),ol.proj.addCoordinateTransforms("EPSG:4326","EPSG:32661",function(e){return AstroGeometry.transformLatLonToPolarMeters(e,"north-polar stereographic",n)},function(e){return AstroGeometry.transformPolarMetersToLatLon(e,"north-polar stereographic",n)});var s=new ol.proj.Projection({code:"EPSG:32761",extent:[-2357032,-2357032,2357032,2357032],worldExtent:[0,-90,360,-60],units:"m"});ol.proj.addProjection(s),ol.proj.addCoordinateTransforms("EPSG:32761",s,function(e){return AstroGeometry.transformLatLonToPolarMeters(e,"south-polar stereographic",n)},function(e){return AstroGeometry.transformPolarMetersToLatLon(e,"south-polar stereographic",n)}),ol.proj.addCoordinateTransforms("EPSG:4326","EPSG:32761",function(e){return AstroGeometry.transformLatLonToPolarMeters(e,"south-polar stereographic",n)},function(e){return AstroGeometry.transformPolarMetersToLatLon(e,"south-polar stereographic",n)});var o=new ol.proj.Projection({code:"undangle",units:"degrees"});ol.proj.addProjection(o),ol.proj.addCoordinateTransforms("EPSG:4326","undangle",function(e){return AstroGeometry.transformDanglers(e)},function(e){return AstroGeometry.transformDanglers(e)});var u=new ol.proj.Projection({code:"truncate",units:"degrees"});ol.proj.addProjection(u),ol.proj.addCoordinateTransforms("EPSG:4326","truncate",function(e){return AstroGeometry.transformTruncate(e)},function(e){return AstroGeometry.transformTruncate(e)}),this.projection=="cylindrical"?this.currentProj="EPSG:4326":this.projection=="north-polar stereographic"?this.currentProj=i:this.currentProj=s,mapPopup=document.getElementById("mapPopup");var a=new ol.Overlay({element:mapPopup,autoPan:!0,autoPanAnimation:{duration:250}});this.mapOverlay=a,view=new ol.View({zoom:t,center:[180,0],projection:this.currentProj,minZoom:2,maxZoom:10});var f={controls:[],target:"map",view:view,overlays:[a],layers:this.mapsLoaded};this.map=new ol.Map(f),this.console==null&&this.consoleSettings!=null&&(this.console=new AstroConsole(this,this.consoleSettings)),this.console&&this.console.toggleProjection(this.projection),this.boundingBoxSource=new ol.source.Vector,this.boundingBoxLayer=new ol.layer.Vector({source:this.boundingBoxSource,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.2)"}),stroke:new ol.style.Stroke({color:"#ff0000",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})}),this.map.addLayer(this.boundingBoxLayer),this.boundingBoxDrawer==null?this.boundingBoxDrawer=new AstroBoundingBox(this,this.boundingBoxSource,this.boundingBoxSettings):this.boundingBoxDrawer.updateLayer&&this.boundingBoxDrawer.updateLayer(this.boundingBoxSource),this.vectorSource=new ol.source.Vector({wrapX:!1}),this.vectorLayer=new ol.layer.Vector({source:this.vectorSource,extent:[0,-90,360,90],style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.2)"}),stroke:new ol.style.Stroke({color:"#ff0000",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})}),this.vectorLayer.set("selectable",!0),this.map.addLayer(this.vectorLayer),this.poiSource=new ol.source.Vector({wrapX:!1}),this.poiLayer=new ol.layer.Vector({source:this.poiSource,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.2)"}),stroke:new ol.style.Stroke({color:"#ff0000",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})}),this.poiLayer.set("selectable",!0),this.map.addLayer(this.poiLayer),imageTitle="Footprint Images",this.imageSource=null,this.imageLayer=new ol.layer.Image({title:imageTitle}),this.overLayerGroup&&this.overLayerGroup.getLayers().push(this.imageLayer),this.controls==null&&(this.controls=new AstroControls(this,this.controlSettings))},AstroMap.prototype.loadImage=function(e,t){imageTitle="Footprint Images",this.imageSource=new ol.source.ImageStatic({attributions:[new ol.Attribution({html:""})],url:e,projection:this.projection,imageExtent:t}),this.imageLayer.setSource(this.imageSource)},AstroMap.prototype.setImageOpacity=function(e){this.imageLayer.setOpacity(e)},AstroMap.prototype.loadLayers=function(e,t,n,r){var i=!1;this.hasNorthPolar=!1,this.hasSouthPolar=!1,baseLayers=[],overLayers=[];var s=myJSONmaps.targets;for(var o=0,u=s.length;o<u;o++){var a=s[o];if(a["name"].toLowerCase()==e){var f=a.aaxisradius,l=2*Math.PI*f*39370.0787;this.aAxisRadius=a.aaxisradius,this.bAxisRadius=a.baxisradius,this.cAxisRadius=a.caxisradius;var c=a.webmap;for(var h=0,p=c.length;h<p;h++){var d=c[h];switch(d.type){case"WMS":d["projection"]=="north-polar stereographic"?this.hasNorthPolar=!0:d["projection"]=="south-polar stereographic"&&(this.hasSouthPolar=!0);if(d["projection"]==t){var v=r,m=1.40625,g=11,y=[d.bounds.left,d.bounds.bottom,d.bounds.right,d.bounds.top];d["units"]=="m"&&(v=!1,m=2e4,g=8,boundsExtent=y);var b=this.deepZoom?2:0,w=d["transparent"]=="false"?!0:!1,E=d["layer"]=="NOMENCLATURE"&&n?!0:!1,S=d["layer"]=="NOMENCLATURE"?!0:!1,x="";x+=d.citation.length>0?" "+d.citation:"",x+=d.notes.length>0?" "+d.notes:"",w?(isPrimary=d["primary"]=="true",baseLayers.push(new ol.layer.Tile({title:d.displayname,type:"base",visible:isPrimary,maxResolution:m,source:new ol.source.TileWMS({url:d.url+"?map="+d.map,params:{LAYERS:d.layer},serverType:"mapserver",crossOrigin:"anonymous",wrapX:v})}))):overLayers.push(new ol.layer.Tile({title:d.displayname,visible:!1,maxResolution:m,enableOpacitySliders:!0,source:new ol.source.TileWMS({url:d.url+"?map="+d.map,params:{LAYERS:d.layer,TILED:!0},crossOrigin:"anonymous",wrapX:v})}))}break;case"WFS":this.nomenWFSURL=d.url}}}}var T=new ol.source.Vector({format:new ol.format.GeoJSON,url:function(e){return"https://astrocloud.wr.usgs.gov/dataset/data/nomenclature/"+a.name.toUpperCase()+"/WFS?service=WFS&version=1.1.0&request=GetFeature&"+"outputFormat=application/json&srsname=EPSG:4326&"+"bbox="+e.join(",")+",EPSG:4326"},serverType:"geoserver",crossOrigin:"anonymous",strategy:ol.loadingstrategy.bbox}),N=new ol.layer.Vector({source:T,style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(0, 0, 255, 1.0)",width:2})})});return group1=new ol.layer.Group({title:"Base maps",layers:baseLayers}),this.baseLayerGroup=group1,overLayers.length>0?(group2=new ol.layer.Group({title:"Overlays",layers:overLayers}),this.overLayerGroup=group2,[group1,group2]):[group1]},AstroMap.prototype.loadDummyLayer=function(){var e="http://planetarymaps.usgs.gov/cgi-bin/mapserv",t="/maps/generic/generic_simp_cyl.map",n="MINECRAFT",r=[0,-90,360,90],i=1.40625,s=[];return s.push(new ol.layer.Tile({title:"NO IMAGE AVAILABLE",type:"base",visible:!0,maxResolution:i,source:new ol.source.TileWMS({url:e+"?map="+t,params:{LAYERS:n},serverType:"mapserver",wrapX:!0})})),group1=new ol.layer.Group({title:"Base map",layers:s}),[group1]},AstroMap.prototype.switchProjection=function(e){if(e=="north-polar stereographic"&&!this.hasNorthPolar){alert("North Polar image is NOT AVAILABLE");return}if(e=="south-polar stereographic"&&!this.hasSouthPolar){alert("South Polar image is NOT AVAILABLE");return}this.destroy(),this.mapSettings.projection=e,this.init(),this.projectionSwitchTrigger()},AstroMap.prototype.zoom=function(e){this.homeLonLat?this.map.moveTo(this.homeLonLat,e):astroMap.map.zoomTo(e)},AstroConsole.prototype.targetInfoSetup=function(){var e=document.getElementById(this.targetInfoDiv),t=document.createElement("img");t.setAttribute("id",this.targetImgId),t.setAttribute("alt",this.target),t.setAttribute("title",this.target),t.setAttribute("src",this.imagePath+this.target.toLowerCase()+".png"),t.className="astroConsoleTargetImg",e.appendChild(t);var n=document.createElement("span");n.className="astroConsoleTargetName",n.innerHTML=this.target+"<br/>",e.appendChild(n)},AstroConsole.prototype.mouseLonLatSetup=function(){var e=document.getElementById(this.targetInfoDiv),t=document.createElement("div");t.className="astroConsoleLonLatTitle",t.innerHTML="Lat Lon: &nbsp;",e.appendChild(t);var n=document.createElement("div");n.setAttribute("id",this.mouseLonLatDiv),n.className="astroConsoleLonLat",e.appendChild(n)},AstroConsole.prototype.featureFinderSetup=function(){var e=document.getElementById(this.featureFinderDiv),t=document.createElement("select");t.setAttribute("id",this.featureTypeSelectId),t.className="astroConsoleSelect";var n=document.createElement("option");n.text="Select Type. . .",n.value="t",t.appendChild(n),e.appendChild(t);var r=document.getElementById(this.featureFinderDiv),i=document.createElement("select");i.setAttribute("id",this.featureNameSelectId),i.className="astroConsoleSelect",i.disabled=!0;var s=document.createElement("option");s.text="Select Name. . .",s.value="t",i.appendChild(s),r.appendChild(i)},AstroConsole.prototype.featureFinderLoadTypes=function(e){$.ajax({url:this.upcAjaxURLNoParams,dataType:"json",data:"act=featureTypesAjaxGet&target="+e,type:"POST",success:function(e){if(!!e){var t=document.getElementById("upcFeatureType");t.options.length=0;var n=document.createElement("option");n.innerHTML="Select Type. . .",t.appendChild(n);var r=e.featureTypes.type;for(var i in e.featureTypes.type)n=document.createElement("option"),n.text=r[i],n.innerHTML=r[i],n.setAttribute("value",r[i]),t.appendChild(n)}}})},AstroConsole.prototype.projButtonsSetup=function(){var e=document.getElementById(this.projButtonsDiv),t=document.createElement("img");t.setAttribute("id",this.northPoleImgId),t.setAttribute("alt","North Polar Stereographic"),t.setAttribute("title","North Polar Stereographic"),t.setAttribute("src",this.imagePath+"north-pole.png"),t.className="astroConsoleProjectionButton";var n=this;t.addEventListener("click",function(){n.astroMap.switchProjection("north-polar stereographic")}),e.appendChild(t);var r=document.createElement("img");r.setAttribute("id",this.cylindricalImgId),r.setAttribute("alt","Simple Cylindrical"),r.setAttribute("title","Simple Cylindrical"),r.setAttribute("src",this.imagePath+"cylindrical.png"),r.className="astroConsoleProjectionButton",r.addEventListener("click",function(){n.astroMap.switchProjection("cylindrical")}),e.appendChild(r);var i=document.createElement("img");i.setAttribute("id",this.southPoleImgId),i.setAttribute("alt","South Polar Stereographic"),i.setAttribute("title","South Polar Stereographic"),i.setAttribute("src",this.imagePath+"south-pole.png"),i.className="astroConsoleProjectionButton",i.addEventListener("click",function(){n.astroMap.switchProjection("south-polar stereographic")}),e.appendChild(i)},AstroConsole.prototype.toggleProjection=function(e){switch(e){case"cylindrical":document.getElementById(this.cylindricalImgId).src=this.imagePath+"cylindrical-hot.png",document.getElementById(this.northPoleImgId).src=this.imagePath+"north-pole.png",document.getElementById(this.southPoleImgId).src=this.imagePath+"south-pole.png";break;case"north-polar stereographic":document.getElementById(this.cylindricalImgId).src=this.imagePath+"cylindrical.png",document.getElementById(this.northPoleImgId).src=this.imagePath+"north-pole-hot.png",document.getElementById(this.southPoleImgId).src=this.imagePath+"south-pole.png";break;case"south-polar stereographic":document.getElementById(this.cylindricalImgId).src=this.imagePath+"cylindrical.png",document.getElementById(this.northPoleImgId).src=this.imagePath+"north-pole.png",document.getElementById(this.southPoleImgId).src=this.imagePath+"south-pole-hot.png"}},AstroConsole.prototype.lonLatSelectsSetup=function(e,t){var n=document.getElementById(this.lonLatSelectsDiv),r=document.createElement("select");r.setAttribute("id",this.lonDirSelectId),r.className="astroConsoleSelect";var i=e=="PositiveWest"?"SELECTED":"",s=document.createElement("option");s.text="Positive East",s.value="PositiveEast";var o=document.createElement("option");o.text="Positive West",o.value="PositiveWest"+i;try{r.add(s,null),r.add(o,null)}catch(u){r.add(s),r.add(o)}var a=document.createElement("div");a.appendChild(r),n.appendChild(a);var f=document.createElement("select");f.setAttribute("id",this.lonDomSelectId),f.className="astroConsoleSelect",i=t==360?"SELECTED":"";var l=document.createElement("option");l.text="0° to 360°",l.value="360";var c=document.createElement("option");c.text="-180° to 180° ",c.value="180"+i;try{f.add(l,null),f.add(c,null)}catch(u){f.add(l),f.add(c)}var h=document.createElement("div");h.appendChild(f),n.appendChild(h);var p=document.createElement("select");p.setAttribute("id",this.latTypeSelectId),p.className="astroConsoleSelect";var d=document.createElement("option");d.text="Planetocentric",d.value="Planetocentric";var v=document.createElement("option");v.text="Planetographic",v.value="Planetographic";try{p.add(d,null),p.add(v,null)}catch(u){p.add(d),p.add(v)}var m=document.createElement("div");m.appendChild(p),n.appendChild(m)},AstroConsole.prototype.addKey=function(e,t){this.key.push(e);var n=t==null?this.keyColors[this.key.length-1]:t,r=null,i=5;this.key.length==1||this.key.length%i==0?(r=document.createElement("div"),r.setAttribute("id",this.keyDiv+""+Math.floor(this.key.length/i)),r.className="astroConsoleKeyDiv",document.getElementById(this.keyDiv).appendChild(r)):r=document.getElementById(this.keyDiv+""+Math.floor(this.key.length/i));var s=document.createElement("img");s.setAttribute("alt",e),s.setAttribute("title",e),s.setAttribute("src",this.imagePath+"glowBox_"+n+".png"),s.className="upcRenderBullet",r.appendChild(s);var o=document.createElement("span");o.className="astroConsoleKeyTitle",o.innerHTML=" "+e+"<br/>",r.appendChild(o)},AstroConsole.prototype.getKeyColor=function(e){return this.keyColors[this.key.indexOf(e)]},AstroConsole.prototype.removeAllKeys=function(){var e=document.getElementById(this.keyDiv);while(e.hasChildNodes())e.removeChild(e.lastChild);this.key=new Array},AstroVector.prototype.afterVectorFeatureModified=function(e){this.savedIndex=-1},AstroVector.prototype.beforeVectorFeatureModified=function(e){this.savedIndex=this.getVectorIndex(e.feature)},AstroVector.prototype.centerOnStoredVector=function(e,t){this.centerOnVector(this.storedVectors[e].vectorFeature,t)},AstroVector.prototype.centerOnVector=function(e,t){var n=this.astroMap.projection,r=e.getGeometry(),i=new ol.format.WKT,s=i.writeGeometry(r),o=AstroGeometry.extractGeometryType(s),u;this.astroMap.projection=="cylindrical"&&(o=="MULTIPOLYGON"&&(r=r.getPolygon(0)),o=="MULTILINESTRING"&&(r=r.getLineString(0))),u=ol.extent.getCenter(r.getExtent()),this.astroMap.homeLonLat=u;var a=this.astroMap.map.getView().calculateExtent(this.astroMap.map.getSize()),f=r.getExtent(),l=!1,c=ol.extent.containsExtent(a,f),h=25;if(c){mapW=Math.abs(a[2]-a[0]),mapH=Math.abs(a[3]-a[1]),vecW=Math.abs(f[2]-f[0]),vecH=Math.abs(f[3]-f[1]);if(vecW>mapW||vecH>mapH)l=!0;else{wXbig=mapW/vecW,hXbig=mapH/vecH;if(wXbig>h||hXbig>h)l=!0}}else l=!0;(t||l)&&this.astroMap.map.getView().fit(r,this.astroMap.map.getSize(),{padding:[50,50,50,50]})},AstroVector.prototype.convertHexColor=function(e,t){var n=ol.color.asArray(e);return n=n.slice(),n[3]=t,n},AstroVector.prototype.drawAndStore=function(e,t,n,r,i,s){var o=this.draw(e,t,n,r,i,s);return o.index=this.storedVectors.length,this.storedVectors.push(o),o},AstroVector.prototype.draw=function(e,t,n,r,i,s){var o={},u,a=!1,f=this.astroMap.projection,l;e=AstroGeometry.cleanWkt(e),o.drawWKT=e,o.searchWKT="",o.splitWKT="",o.color=n,o.id=r,o.center=i,o.datelineShift=s,t||(t={});var c=new ol.format.WKT;if(f=="cylindrical"){l=c.readGeometry(e);var h=l.getExtent(),p=ol.extent.getBottomRight(h)[0],d=ol.extent.getBottomLeft(h)[0],v=ol.extent.getWidth(h);if(v>360||p>360&&d>360||p<0&&d<0)e=AstroGeometry.undangle(e);o.searchWKT=e,AstroGeometry.crossesDateline(e,f)&&(o.splitWKT=AstroGeometry.splitOnDateline(e,f)),s&&(o.drawWKT=AstroGeometry.datelineShift(e))}else{l=c.readGeometry(e),wktLatLon=c.writeGeometry(l,{decimals:2});var m=wktLatLon;o.searchWKT=wktLatLon,AstroGeometry.crossesDateline(e,f)?(o.splitWKT=AstroGeometry.splitOnDateline(wktLatLon,f),m=AstroGeometry.warpWkt(o.splitWKT)):m=AstroGeometry.warpWkt(wktLatLon);var g=c.readGeometry(m);f=="north-polar stereographic"?g=g.transform("EPSG:4326","EPSG:32661"):g=g.transform("EPSG:4326","EPSG:32761"),o.drawWKT=c.writeGeometry(g,{decimals:2})}u=c.readFeature(o.drawWKT),u.attributes=t,u.attributes.color=n,u.data=t,o.vectorFeature=u;if(n){if(!this.styles[n]){var y=new ol.style.Style({fill:new ol.style.Fill({color:this.convertHexColor(n,.2)}),stroke:new ol.style.Stroke({color:this.convertHexColor(n,1)})});this.styles[n]=y}u.setStyle(this.styles[n])}return this.layer.addFeatures([u]),i&&this.astroMap.mapsLoaded&&this.centerOnVector(u),o},AstroVector.prototype.getExtent=function(e){var t=[];return this.storedVectors[e]!=null&&(geo=this.storedVectors[e].vectorFeature.getGeometry(),t=geo.getExtent()),t},AstroVector.prototype.getFeatureFromAttribute=function(e,t){for(var n=0;n<this.storedVectors.length;n++)if(this.storedVectors[n]!=null&&this.storedVectors[n].vectorFeature.attributes[e]==t)return this.storedVectors[n].vectorFeature;return-1},AstroVector.prototype.getVectorIndex=function(e){for(var t=0,n=this.storedVectors.length;t<n;t++)if(this.storedVectors[t]!=null&&this.storedVectors[t].vectorFeature==e)return t;return-1},AstroVector.prototype.getVectorIndexFromAttribute=function(e,t){for(var n=0,r=this.storedVectors.length;n<r;n++)if(this.storedVectors[n]!=null&&this.storedVectors[n].vectorFeature.attributes[e]==t)return n;return-1},AstroVector.prototype.highlight=function(e){this.storedVectors[e]!=null&&this.storedVectors[e].vectorFeature.setStyle(this.selectStyle)},AstroVector.prototype.highlightVector=function(e){var t=this.getVectorIndex(e);this.storedVectors[t].vectorFeature.setStyle(this.selectStyle)},AstroVector.prototype.isDrawable=function(e){var t=e.getExtent(),n=!1;switch(astroMap.projection){case"cylindrical":n=!0;break;case"north-polar stereographic":n=ol.extent.getBottomRight(t)[1]>60?!0:!1;break;case"south-polar stereographic":n=ol.extent.getTopRight(t)[1]<-60?!0:!1}return n},AstroVector.prototype.redraw=function(){var e=0,t=!0;for(var n=0,r=this.storedVectors.length;n<r;n++){if(!this.storedVectors[n])continue;var i=this.storedVectors[n],s=i.vectorFeature.getGeometry();if(this.isDrawable(s)){var o=this.draw(i.searchWKT,i.vectorFeature.attributes,i.color,i.id,i.center,i.datelineShift);this.storedVectors[n]=o}}},AstroVector.prototype.remove=function(e){this.astroMap.controls.select,this.layer.removeFeature(e),this.astroMap.controls.select&&this.astroMap.controls.select.getFeatures().clear()},AstroVector.prototype.removeAndUnstore=function(e){this.storedVectors[e]!=null&&this.remove(this.storedVectors[e].vectorFeature),this.storedVectors[e]=null},AstroVector.prototype.removeAndUnstoreVector=function(e){var t=this.getVectorIndex(e);this.removeAndUnstore(t)},AstroVector.prototype.removeAll=function(){this.layer.removeAllFeatures()},AstroVector.prototype.removeAndUnstoreAll=function(){this.layer.clear(),this.storedVectors=[]},AstroVector.prototype.updateLayer=function(e){this.layer=e,this.redraw()},AstroVector.prototype.unhighlight=function(e){if(this.storedVectors[e]!=null){var t=this.storedVectors[e].vectorFeature.attributes.color;this.storedVectors[e].vectorFeature.setStyle(this.styles[t])}},AstroVector.prototype.unhighlightAll=function(){for(var e=0,t=this.storedVectors.length;e<t;e++)this.unhighlight(e)},AstroVector.prototype.vectorFeatureModified=function(e){if(this.savedIndex!=-1){var t=this.astroMap.wktParse.write(e.feature);this.storedVectors[this.savedIndex].vectorFeature=e.feature,this.storedVectors[this.savedIndex].drawWKT=t}},AstroBoundingBox.prototype=new AstroVector,AstroBoundingBox.prototype.constructor=AstroBoundingBox,AstroBoundingBox.prototype.drawAndStore=function(e,t,n){n||(n=!0),this.multiVectorEdit=this.astroMap.controls.multiVectorEdit,this.multiVectorEdit&&document.getElementById(this.formIdWKT).value!=""&&e.indexOf("MULTI")==-1&&(e=this.mergeVectors(e,document.getElementById(this.formIdWKT).value)),this.removeAndUnstoreAll(t);var r=AstroVector.prototype.drawAndStore.call(this,e,null,null,"footprint",n,!1);return this.centerOnVector(r.vectorFeature,!0),r!=null&&(document.getElementById(this.formIdDatelineWKT)&&(document.getElementById(this.formIdDatelineWKT).value=r.splitWKT),t||this.populateForm(r.drawWKT,r.searchWKT,r.splitWKT)),r},AstroBoundingBox.prototype.drawFromBounds=function(e){var t,n,r,i;t=document.getElementById(this.formIdTopLeftLon).value,n=document.getElementById(this.formIdTopLeftLat).value,r=document.getElementById
(this.formIdBotRightLon).value,i=document.getElementById(this.formIdBotRightLat).value;if(t.length<1||n.length<1||r.length<1||i.length<1)return null;if(Number(t)>Number(r)){var s="",o="",u=100;if(Number(n)==90||Number(i)==90)s=r+" 90,",o=t+" 90,",u=Number(n)>Number(i)?Number(i):Number(n);if(Number(n)==-90||Number(i)==-90)s=r+" -90,",o=t+" -90,",u=Number(n)<Number(i)?Number(i):Number(n);if(Number(u)!=100){var a=((Number(t)+Number(r))/2).toString()+" "+u+",";wkt="POLYGON(("+t+" "+u+","+a+r+" "+u+","+s+o+t+" "+u+"))"}else{var f=Math.floor((Number(r)+Number(t))/2).toString()+" "+n+",",l=Math.floor((Number(r)+Number(t))/2).toString()+" "+i+",";wkt="POLYGON(("+t+" "+n+","+r+" "+n+","+r+" "+i+","+t+" "+i+","+t+" "+n+"))",wkt=AstroGeometry.splitOnDateline(wkt,this.astroMap.projection)}e=!0}else{var a=((Number(t)+Number(r))/2).toString()+" "+n+",",c=((Number(t)+Number(r))/2).toString()+" "+i+",";wkt="POLYGON(("+t+" "+n+","+a+r+" "+n+","+r+" "+i+","+c+t+" "+i+","+t+" "+n+"))"}return document.getElementById(this.formIdWKT).value=wkt,this.drawAndStore(wkt,e)},AstroBoundingBox.prototype.drawFromControl=function(e){if(this.astroMap.projection!="cylindrical"){var t=new ol.format.WKT;geometry=t.readGeometry(e),this.astroMap.projection=="north-polar stereographic"?geometry=geometry.transform("EPSG:32661","EPSG:4326"):geometry=geometry.transform("EPSG:32761","EPSG:4326");if(!AstroVector.prototype.isDrawable(geometry))return alert("Bounding Box is not visable in this projection!"),null;e=t.writeGeometry(geometry)}return this.drawAndStore(e)},AstroBoundingBox.prototype.drawFromForm=function(){var e=document.getElementById(this.formIdWKT).value;return e?this.drawAndStore(e):null},AstroBoundingBox.prototype.drawFromServerUpload=function(e){if(e){var t=this.astroMap.minorReprojectWKT(e,!0);return this.drawAndStore(t)}return null},AstroBoundingBox.prototype.drawFromMapExtent=function(){var e=this.astroMap.map.getExtent();return document.getElementById(this.formIdTopLeftLon).value=e.left<0?"":e.left,document.getElementById(this.formIdTopLeftLat).value=e.top>90?"":e.top,document.getElementById(this.formIdBotRightLon).value=e.right>360?"":e.right,document.getElementById(this.formIdBotRightLat).value=e.bottom<-90?"":e.bottom,this.drawFromBounds()},AstroBoundingBox.prototype.drawFromCenterPointAndDiameter=function(){var e=document.getElementById(this.formIdTopLeftLon).value,t=document.getElementById(this.formIdWKT).value,n=document.getElementById(this.formIdCenterLat).value,r=document.getElementById(this.formIdCenterLon).value,i=document.getElementById(this.formIdLength).value;return!n||!r||Number(i)<=0?null:(document.getElementById(this.formIdTopLeftLon).value=r,document.getElementById(this.formIdTopLeftLat).value=n,document.getElementById(this.formIdBotRightLon).value=r,document.getElementById(this.formIdBotRightLat).value=n,document.getElementById(this.formIdCenterpoint).value="POINT("+r+" "+n+")",document.getElementById(this.formIdWKT).value="POINT("+r+" "+n+")",null)},AstroBoundingBox.prototype.populateForm=function(e,t,n){var r=new ol.format.WKT,i=null,s=r.readFeature(e),o=s.getGeometry(),u=this.astroMap.controls.decimalPlaces,a=r.readFeature(t),f=a.getGeometry(),l="",c="";document.getElementById(this.formIdWKT).value=t,n!=""&&document.getElementById(this.formIdDatelineWKT)&&(l=r.readFeature(n),c=l.getGeometry(),c=c.transform("EPSG:4326","truncate"),n=r.writeGeometry(c),document.getElementById(this.formIdDatelineWKT).value=n),document.getElementById(this.formIdCenterpoint);if(document.getElementById(this.formIdTopLeftLon)){var h=f.getExtent(),p=ol.extent.getTopRight(h)[1],d=ol.extent.getBottomRight(h)[1];if(n!=""){var v=ol.extent.getBottomLeft(h)[0],m=ol.extent.getBottomRight(h)[0],g=c.getExtent();this.astroMap.projection=="north-polar stereographic"&&ol.extent.getTopRight(g)[1]==90&&(p=90),this.astroMap.projection=="south-polar stereographic"&&ol.extent.getBottomRight(g)[1]==-90&&(d=-90)}else var v=ol.extent.getBottomRight(h)[0],m=ol.extent.getBottomLeft(h)[0];var y=this.astroMap.longitudeDirection=="PositiveWest"?v:m,b=this.astroMap.longitudeDirection=="PositiveWest"?m:v;document.getElementById(this.formIdTopLeftLon).value=u?y.toFixed(u):y,document.getElementById(this.formIdBotRightLon).value=u?b.toFixed(u):b,document.getElementById(this.formIdTopLeftLat).value=u?p.toFixed(u):p,document.getElementById(this.formIdBotRightLat).value=u?d.toFixed(u):d}},AstroBoundingBox.prototype.removeAndUnstoreAll=function(e){AstroVector.prototype.removeAndUnstoreAll.call(this),this.boundingBoxRemoveTrigger();if(!e){var t=[this.formIdWKT,this.formIdDatelineWKT,this.formIdCenterpoint,this.formIdCenterLon,this.formIdCenterLat,this.formIdTopLeftLon,this.formIdTopLeftLat,this.formIdBotRightLon,this.formIdBotRightLat,this.formIdLength];for(var n=0;n<t.length;n++)document.getElementById(t[n])&&(document.getElementById(t[n]).value="")}},AstroBoundingBox.prototype.featureSearch=function(featureQuery){var astroLockout=new AstroLockout,nomenUrl="http://planetarynames.wr.usgs.gov/SearchResults?target=MARS&feature="+featureQuery+"&displayType=JSON";nomenUrl=encodeURIComponent(nomenUrl);var proxyUrl="http://kirks.wr.usgs.gov/cgi-bin/proxy.cgi?url="+nomenUrl,success=function(response){var searchResults=eval("("+response.responseText+")");this.boundingBoxFeatureSearchResultHandler(searchResults),astroLockout.off("featureSearch")},error=function(e){this.boundingBoxFeatureSearchResultHandler(null),astroLockout.off("featureSearch")};astroLockout.on("featureSearch",!0),OpenLayers.loadURL(proxyUrl,"",this,success,error)},AstroBoundingBox.prototype.scaleBoundingBox=function(e,t){var n=this.astroMap.wktParseS.read(e);if(n!=null){var r=n.geometry.getCentroid();return n.geometry.resize(t,r),this.astroMap.wktParseS.write(n)}return null},AstroBoundingBox.prototype.vectorFeatureModified=function(e){AstroVector.prototype.vectorFeatureModified.call(this,e);var t=this.astroMap.wktParseR.read(e.feature.geometry.toString()).geometry,n=null,r=!1,i=t;if(this.astroMap.controls.controls.editCenterPoint){var s=this.astroMap.controls.panel.getControlsBy("active",!0);for(var o=0;o<s.length;o++)if(s[o].displayClass=="olControlEditCenterPoint"){r=!0,this.astroMap.controls.dontConvertForm&&(t=this.astroMap.minorReprojectGeo(t,!1)),newCenter=t;var u=this.astroMap.controls.decimalPlaces,a=u?newCenter.x.toFixed(u):newCenter.x,f=u?newCenter.y.toFixed(u):newCenter.y;this.astroMap.controls.dontConvertForm?this.setCenterWKT(i.x,i.y):this.setCenterWKT(geo.x,geo.y),document.getElementById(this.formIdCenterLon).value=a,document.getElementById(this.formIdCenterLat).value=f}else n=s[o]}if(!r){var l=t;if(astroMap.controls.decimalPlaces){OpenLayers.Projection.addTransform("LatLonTruncate","EPSG:4326",AstroGeometry.transformCylindricalToLatLon),OpenLayers.Projection.addTransform("EPSG:4326","LatLonTruncate",astroMap.controls.transformDecimalPlaces);var c=new OpenLayers.Projection("EPSG:4326"),h=new OpenLayers.Projection("LatLonTruncate");l=l.transform(c,h)}var p=l.toString(),d=this.drawAndStore(p);n&&n.selectFeature(d.vectorFeature)}},AstroBoundingBox.prototype.editCenterPointStart=function(e){var t=document.getElementById("astroBBCenterPoint").value;this.centerPoint||(this.centerPoint=this.astroMap.boundingBoxDrawer.draw(t,null,"blue")),this.astroMap.controls.controls.editCenterPoint.selectFeature(this.centerPoint.vectorFeature)},AstroBoundingBox.prototype.editCenterPointStop=function(e){this.centerPoint&&this.astroMap.boundingBoxDrawer.remove(this.centerPoint.vectorFeature),this.centerPoint=null},AstroBoundingBox.prototype.polarSafeWKT=function(e){if(this.astroMap.projection!="cylindrical"){var t=new ol.format.WKT;geometry=t.readGeometry(e),this.astroMap.projection=="north-polar stereographic"?geometry=geometry.transform("EPSG:4326","EPSG:32661"):geometry=geometry.transform("EPSG:4326","EPSG:32761"),e=t.writeGeometry(geometry)}return e},AstroBoundingBox.prototype.setCenterWKT=function(e,t){var n=document.getElementById(this.formIdCenterpoint),r=!1;if(n){if(!e||!t)e=document.getElementById(this.formIdCenterLon).value,t=document.getElementById(this.formIdCenterLat).value,this.astroMap.controls.dontConvertForm&&(r=!0);var i=this.astroMap.controls.decimalPlaces,s=i?e.toFixed(i):e,o=i?t.toFixed(i):t,u="POINT("+s+" "+o+")";r&&(u=this.astroMap.minorReprojectWKT(u,!1)),n.value=u}},AstroBoundingBox.prototype.mergeVectors=function(e,t){var n=astroMap.wktParse,r=n.read(e).geometry,i=n.read(t).geometry,s=[];t.indexOf("MULTI")!=-1?s=i.components.concat(r):s=[r,i];if(e.indexOf("POLYGON")!=-1)var o=(new OpenLayers.Geometry.MultiPolygon(s)).toString();else var o=(new OpenLayers.Geometry.MultiLineString(s)).toString();return o},AstroBoundingBox.prototype.updateLayer=function(e){this.layer=e,this.redraw()},AstroPoi.prototype.centerOn=function(e){var t=this.astroMap.projection,n,r=e.getGeometry();n=ol.extent.getCenter(r.getExtent()),this.astroMap.homeLonLat=n,this.astroMap.map.getView().fit(r,this.astroMap.map.getSize(),{padding:[50,50,50,50]})},AstroPoi.prototype.convertHexColor=function(e,t){var n=ol.color.asArray(e);return n=n.slice(),n[3]=t,n},AstroPoi.prototype.drawAndStore=function(e,t,n,r,i){var s=this.draw(e,t,n,r,i);return s.index=this.storedPois.length,this.storedPois.push(s),s},AstroPoi.prototype.draw=function(e,t,n,r,i){var s={},o,u=this.astroMap.projection,a;wktString=this.makePoint(e,t),s.WKT="POINT("+t+" "+e+")",s.id=r,s.center=i,n||(n={});var f=new ol.format.WKT;return u!="cylindrical"&&(a=f.readGeometry(s.WKT),u=="north-polar stereographic"?a=a.transform("EPSG:4326","EPSG:32661"):a=a.transform("EPSG:4326","EPSG:32761"),wktLatLon=f.writeGeometry(a,{decimals:2}),s.WKT=wktLatLon),o=f.readFeature(s.WKT),o.attributes=n,o.data=n,s.vectorFeature=o,this.layer.addFeatures([o]),s},AstroPoi.prototype.getFeatureFromAttribute=function(e,t){for(var n=0;n<this.storedPois.length;n++)if(this.storedPois[n]!=null&&this.storedPois[n].vectorFeature.attributes[e]==t)return this.storedPois[n].vectorFeature;return-1},AstroPoi.prototype.getVectorIndex=function(e){for(var t=0,n=this.storedPois.length;t<n;t++)if(this.storedPois[t]!=null&&this.storedPois[t].vectorFeature==e)return t;return-1},AstroPoi.prototype.getVectorIndexFromAttribute=function(e,t){for(var n=0,r=this.storedPois.length;n<r;n++)if(this.storedPois[n]!=null&&this.storedPois[n].vectorFeature.attributes[e]==t)return n;return-1},AstroPoi.prototype.highlight=function(e){this.storedPois[e]!=null&&this.storedPois[e].vectorFeature.setStyle(this.selectStyle)},AstroPoi.prototype.highlightVector=function(e){var t=this.getVectorIndex(e);this.storedPois[t].vectorFeature.setStyle(this.selectStyle)},AstroPoi.prototype.isDrawable=function(e){var t=e.getExtent(),n=!1;switch(astroMap.projection){case"cylindrical":n=!0;break;case"north-polar stereographic":n=ol.extent.getBottomRight(t)[1]>60?!0:!1;break;case"south-polar stereographic":n=ol.extent.getTopRight(t)[1]<-60?!0:!1}return n},AstroPoi.prototype.makePoint=function(e,t){return point="POINT("+t+","+e+")",point},AstroPoi.prototype.redraw=function(){var e=0,t=!0;for(var n=0,r=this.storedPois.length;n<r;n++){if(!this.storedPois[n])continue;var i=this.storedPois[n],s=i.vectorFeature.getGeometry();if(this.isDrawable(s)){var o=this.draw(i.searchWKT,i.vectorFeature.attributes,i.color,i.id,i.center,i.datelineShift);this.storedPois[n]=o}}},AstroPoi.prototype.remove=function(e){this.astroMap.controls.select&&this.astroMap.controls.select.setActive(!1),this.layer.removeFeature(e),this.astroMap.controls.select&&this.astroMap.controls.select.getFeatures().clear()},AstroPoi.prototype.removeAndUnstoreAll=function(){for(var e in this.storedPois)this.remove(this.storedPois[e].vectorFeature);this.storedPois=null},AstroPoi.prototype.removeAndUnstoreVector=function(e){var t=this.getVectorIndex(e);this.removeAndUnstore(t)},AstroPoi.prototype.removeAll=function(){this.layer.removeAllFeatures()},AstroPoi.prototype.removeAndUnstoreAll=function(){this.layer.clear(),this.storedPois=[]},AstroPoi.prototype.updateLayer=function(e){this.layer=e,this.redraw()},AstroPoi.prototype.unhighlight=function(e){if(this.storedPois[e]!=null){var t=this.storedPois[e].vectorFeature.attributes.color;this.storedPois[e].vectorFeature.setStyle(this.styles[t])}},AstroPoi.prototype.unhighlightAll=function(){for(var e=0,t=this.storedPois.length;e<t;e++)this.unhighlight(e)},AstroControls.prototype.activateButton=function(e){var t=null;for(var n=0;n<this.buttons.length;n++)t=document.getElementById(this.buttons[n]+"Button"),this.buttons[n]==e&&e!="home"&&e!="download"?t.style.backgroundImage='url("'+this.imagePath+"ol3buttons/"+e+'-hot.png")':t.style.backgroundImage='url("'+this.imagePath+"ol3buttons/"+this.buttons[n]+'.png")'},AstroControls.prototype.boundingBoxButton=function(){drawnFeatures=[],this.deactivateButtons();var e=this,t=e.astroMap.boundingBoxSource;t.on("addfeature",function(t){var n=drawnFeatures.indexOf(t.feature);if(n>-1){var r=new ol.format.WKT,i=r.writeFeature(drawnFeatures[n],{decimals:2});e.astroMap.boundingBoxDrawer.drawFromControl(i)}});var n=function(n){var r=new ol.Collection;e.deactivateButtons(),e.activateButton("polygon"),e.draw||(draw=new ol.interaction.Draw({source:t,type:"Polygon",features:r}),e.draw=draw,draw.on("drawstart",function(n){t.clear(),e.astroMap.boundingBoxDrawer.removeAndUnstoreAll(!1)}),draw.on("drawend",function(t){drawnFeatures.push(t.feature),e.boundingBoxDrawHandler()}),e.astroMap.map.addInteraction(draw))};this.makeButton("polygon",n,"Draw Bounding Box")},AstroControls.prototype.deactivateButtons=function(){this.draw&&(this.astroMap.map.removeInteraction(this.draw),this.draw=null),this.select&&(this.astroMap.map.removeInteraction(this.select),this.select=null);for(var t=0;t<this.buttons.length;t++)e=document.getElementById(this.buttons[t]+"Button"),e.style.backgroundImage='url("'+this.imagePath+"ol3buttons/"+this.buttons[t]+'.png")'},AstroControls.prototype.downloadButton=function(){var e=this,t=function(t){function n(e){var t=e.split(","),n=t[0].match(/:(.*?);/)[1],r=atob(t[1]),i=r.length,s=new Uint8Array(i);while(i--)s[i]=r.charCodeAt(i);return new Blob([s],{type:n})}e.scaleline&&e.astroMap.controls.scaleline.writeToCanvas(),e.deactivateButtons(),e.activateButton("download");var r=document.getElementsByTagName("canvas")[0];anchor=document.getElementById("downloadAnchor"),anchor.download="astro-download.png";var i=r.toDataURL("image/png"),s=n(i),o=URL.createObjectURL(s);anchor.href=o};this.makeButton("download",t,"Download Map")},AstroControls.prototype.expandButton=function(){var e=this,t=function(t){e.deactivateButtons(),e.activateButton("expand"),e.astroMap.controls.expandHandler()};this.makeButton("expand",t,"Expand")},AstroControls.prototype.homeButton=function(){var e=this,t=function(t){e.deactivateButtons(),e.activateButton("home"),e.astroMap.home()};this.makeButton("home",t,"Home")},AstroControls.prototype.layerSwitcher=function(){this.layerSwitcherOn=!0;var e=this,t=new ol.control.LayerSwitcher({graticule:e.graticuleOn,astroMap:e.astroMap,tipLabel:"Layers"});this.astroMap.map.addControl(t)},AstroControls.prototype.makeButton=function(e,t,n){this.buttons.push(e);var r=this;newControl=function(i){var s=i||{},o=document.createElement("a");o.href="#"+e,o.id=e+"Anchor",o.addEventListener("click",t,!1),o.addEventListener("touchstart",t,!1);var u=document.createElement("div");u.className="control "+e+"-control ol-unselectable",u.id=e+"Button",u.style.backgroundImage='url("'+r.imagePath+"ol3buttons/"+e+'.png")',u.style.top=String(r.buttonTop)+"px",u.setAttribute("title",n),r.buttonTop+=r.buttonMargin,u.appendChild(o),ol.control.Control.call(this,{element:u,target:s.target})},ol.inherits(newControl,ol.control.Control),this.astroMap.map.addControl(new newControl)},AstroControls.prototype.navigationButton=function(){var e=this,t=function(t){e.deactivateButtons(),e.activateButton("navigation")};this.makeButton("navigation",t,"Navigate")},AstroControls.prototype.scaleLine=function(){this.scaleLineOn=!0;var e=this.astroMap.cAxisRadius*1e3;this.scaleline=new astro.ScaleLine,this.scaleline.setRadius(e),this.scaleline.render=function(e){var t=e.frameState;t?this.viewState_=t.viewState:this.viewState_=null,this.updateElementAstro()},this.astroMap.map.addControl(this.scaleline)},AstroControls.prototype.selectButton=function(){this.deactivateButtons();var e=this,t=function(t){e.deactivateButtons(),e.activateButton("select"),e.select=new ol.interaction.Select({condition:ol.events.condition.click,wrapX:!1,layers:[e.astroMap.vectorLayer]}),e.astroMap.map.addInteraction(e.select),e.select.on("select",function(t){var n=t.selected;n.length&&n.forEach(function(t){e.astroMap.controls.selectHandler(t)})})};this.makeButton("select",t,"Select Footprint")},AstroControls.prototype.toggleLayer=function(e){var t=this.astroMap.map.getLayersByName(e);t.length>0&&t[0].display()},AstroControls.prototype.overviewMap=function(){this.overviewMapOn=!0,this.astroMap.map.addControl(new ol.control.OverviewMap)},AstroControls.prototype.graticuleOption=function(){this.graticuleOn=!0,latStyle=new ol.style.Text({font:"12px Calibri,sans-serif",textBaseline:"bottom",textAlign:"end",fill:new ol.style.Fill({color:"#eee"})});var e=function(e){return e.toFixed(2)},t=function(e){return""};this.astroMap.projection=="cylindrical"?this.graticule=new ol.Graticule({strokeStyle:new ol.style.Stroke({width:.5,color:"#fff"}),showLabels:!0,lonLabelFormatter:e,latLabelFormatter:e,latLabelStyle:latStyle,lonLabelStyle:latStyle},this.astroMap.projection):this.graticule=new ol.Graticule({strokeStyle:new ol.style.Stroke({width:.5,color:"#fff"}),showLabels:!0,lonLabelFormatter:t,latLabelFormatter:e,latLabelStyle:latStyle,lonLabelStyle:latStyle},this.astroMap.projection),this.graticule.setMap(this.astroMap.map)},AstroControls.prototype.featureSearch=function(){this.featureSearchOn=!0;var e=new OpenLayers.Layer.Vector("Feature Search");this.astroMap.map.addLayers([e]);var t=new OpenLayers.Control.GetFeature({protocol:OpenLayers.Protocol.WFS({url:this.astroMap.nomenWFSURL,featureType:"Nomenclature",featureNS:"http://intraweb-dev/nomen"}),box:!0,hover:!1,multipleKey:"shiftKey",toggleKey:"ctrlKey"});this.astroMap.map.addControl(t),t.activate()},AstroControls.prototype.mousePosition=function(){this.mousePositionOn=!0;var e=this.astroMap.console?this.astroMap.console.mouseLonLatDiv:this.mouseLonLatDiv;if(document.getElementById(e)){document.getElementById(e).innerHTML="";var t=new ol.control.MousePosition({coordinateFormat:function(e){var t=document.getElementById("astroConsoleLonDomSelect"),n=document.getElementById("astroConsoleLonDirSelect"),r=document.getElementById("astroConsoleLatTypeSelect");return n&&n.options[n.selectedIndex].value=="PositiveWest"&&(e=AstroGeometry.transformPosEastPosWest(e)),t&&t.options[t.selectedIndex].value=="180"&&(e=AstroGeometry.transform0360To180180(e)),t&&t.options[r.selectedIndex].value=="Plantographic"&&(e=AstroGeometry.transformOcentricToOgraphic(e)),ol.coordinate.format(e,"{y}, {x}",2)},projection:this.astroMap.currentProj,className:"custom-mouse-position",target:document.getElementById(e),undefinedHTML:"&nbsp;"});this.astroMap.map.addControl(t)}},AstroControls.prototype.transformDecimalPlaces=function(e){return AstroGeometry.transformDecimalPlaces(e,astroMap.controls.decimalPlaces)},AstroControls.prototype.zoomBar=function(){this.zoomBarOn=!0;var e=new ol.control.Zoom;this.astroMap.map.addControl(e)},AstroGeometry.cleanWkt=function(e){return e=e.replace(/^\s+|\s+$/g,""),e.replace(/\s+\(/g,"(")},AstroGeometry.extractGeometryType=function(e){var t=e.indexOf("(");return t==-1?null:e.substring(0,t)},AstroGeometry.warpWkt=function(e){var t=this.extractGeometryType(e);if(t=="POINT"||t=="MULTIPOINT")return e;if(t=="POLYGON"){var n=e.slice(9,e.length-2).split(",");if(n.length<=16){var r=this.saturatePointArray(n);return"POLYGON(("+r.join()+"))"}return e}if(t=="LINESTRING"){var n=e.slice(11,e.length-1).split(",");if(n.length<=16){var r=this.saturatePointArray(n);return"LINESTRING("+r.join()+")"}return e}if(t=="MULTIPOLYGON"){var i=new ol.format.WKT,s=i.readGeometry(e),o=s.getPolygons(),u=[];for(var a=0,f=o.length;a<f;a++){var n=o[a].getCoordinates(),l=[];n=n[0];for(var c=0,h=n.length;c<h;c++)l[c]=n[c][0]+" "+n[c][1];if(n.length<=16){var r=this.saturatePointArray(l);u[a]="(("+r.join()+"))"}else u[a]="(("+l.join()+"))"}return"MULTIPOLYGON("+u.join()+")"}if(t=="MULTILINESTRING"){var i=new OpenLayers.Format.WKT,p=i.read(e),d=p.getGeometry().components,v=[];for(var a=0,f=d.length;a<f;a++){var m=d[a].toString(),n=m.slice(11,m.length-1).split(",");if(n.length<=16){var r=this.saturatePointArray(n);v[a]="("+r.join()+")"}else v[a]="("+n.join()+")"}return"MULTILINESTRING("+v.join()+")"}return e},AstroGeometry.saturatePointArray=function(e){var t=[],n=0;for(var r=0,i=e.length-1;r<i;r++){var s=e[r].toString().replace(/^\s+|\s+$/g,"").split(" "),o=e[r+1].toString().replace(/^\s+|\s+$/g,"").split(" "),u=!1;Number(s[0])==Number(o[0])&&Number(s[1])==Number(o[1])&&(u=!0),(s[0]==0||s[0]==360)&&(o[0]==0||o[0]==360)&&(u=!0);if(u){t[n]=[e[r]],n+=1;continue}var a=(Number(s[0])+Number(o[0]))/2,f=(Number(s[1])+Number(o[1]))/2,l=(Number(s[0])+Number(a))/2,c=(Number(s[1])+Number(f))/2,h=(Number(o[0])+Number(a))/2,p=(Number(o[1])+Number(f))/2,d=(Number(s[0])+Number(l))/2,v=(Number(s[1])+Number(c))/2,m=(Number(a)+Number(l))/2,g=(Number(f)+Number(c))/2,y=(Number(a)+Number(h))/2,b=(Number(f)+Number(p))/2,w=(Number(o[0])+Number(h))/2,E=(Number(o[1])+Number(p))/2;t[n]=[e[r]],t[n+1]=[(Number(s[0])+d)/2+" "+(Number(s[1])+v)/2],t[n+2]=[d+" "+v],t[n+3]=[(Number(l)+d)/2+" "+(Number(c)+v)/2],t[n+4]=[l+" "+c],t[n+5]=[(Number(l)+m)/2+" "+(Number(c)+g)/2],t[n+6]=[m+" "+g],t[n+7]=[(Number(a)+m)/2+" "+(Number(f)+g)/2],t[n+8]=[a+" "+f],t[n+9]=[(Number(a)+y)/2+" "+(Number(f)+b)/2],t[n+10]=[y+" "+b],t[n+11]=[(Number(h)+y)/2+" "+(Number(p)+b)/2],t[n+12]=[h+" "+p],t[n+13]=[(Number(h)+w)/2+" "+(Number(p)+E)/2],t[n+14]=[w+" "+E],t[n+15]=[(Number(o[0])+w)/2+" "+(Number(o[1])+E)/2],n+=16}return t[n]=[e[r]],t},AstroGeometry.crossesDateline=function(e,t){var n=!1,r=new ol.format.WKT,i=r.readGeometry(e),s=i.getExtent();if(t=="cylindrical"){var o=this.extractGeometryType(e);if(o=="POLYGON"||o=="LINESTRING"){var u=ol.extent.getBottomRight(s)[0],a=ol.extent.getBottomLeft(s)[0],f=Math.max(u,a),l=Math.min(u,a);f>360&&l<360||l<0&&f>0?n=!0:l>f}else{if(o!="MULTIPOLYGON")return o=="POINT"||o=="MULTIPOINT"?!1:!1;var c=i.getPolygons(),h=!1,p=!1;for(var d=0,v=c.length;d<v;d++){var m=r.writeGeometry(c[d]);if(this.crossesDateline(m,t)){n=!0;break}var g=c[d].getExtent();Number(ol.extent.getBottomLeft(g)[0])==0&&(h=!0),Number(ol.extent.getBottomRight(g)[0])==360&&(p=!0)}h&&p&&(n=!0)}}else{t=="north-polar stereographic"?geometryP=i.transform("EPSG:4326","EPSG:32661"):geometryP=i.transform("EPSG:4326","EPSG:32761");var y=geometryP.getExtent(),b=t=="north-polar stereographic"?[[0,0],[0,-2357032]]:[[0,0],[0,2357032]],w=new ol.geom.LineString(b);n=w.intersectsExtent(y)}return n},AstroGeometry.splitOnDateline=function(wktString,projection){var wktPrefix=this.extractGeometryType(wktString),wktParse=new ol.format.WKT,geometry=wktParse.readGeometry(wktString),childWkt,splitWkt,splitPrefix,splitGeo="",childComponents=[];if(wktPrefix=="MULTIPOLYGON"||wktPrefix=="MULTILINESTRING"){var polys=geometry.getPolygons(),newGeometry=wktPrefix=="MULTIPOLYGON"?new ol.geom.MultiPolygon:new ol.geom.MultiLineString;for(var i=0,len=polys.length;i<len;i++){childWkt=wktParse.writeGeometry(polys[i]),splitWkt=this.splitOnDateline(childWkt,projection),splitGeo=wktParse.readGeometry(splitWkt),splitPrefix=this.extractGeometryType(splitWkt),splitPrefix=="POLYGON"||splitPrefix=="LINESTRING"?childComponents[0]=splitGeo:childComponents=wktPrefix=="MULTIPOLYGON"?splitGeo.getPolygons():splitGeo.getLineStrings();for(var j=0,innerLen=childComponents.length;j<innerLen;j++)wktPrefix=="MULTIPOLYGON"?newGeometry.appendPolygon(childComponents[j]):newGeometry.appendLineString(childComponents[j])}return wktParse.writeGeometry(newGeometry)}if(wktPrefix=="POLYGON"){wktString=this.undangle(wktString);var geojson=new ol.format.GeoJSON,f=wktParse.readFeature(wktString),featureJson=geojson.writeFeature(f),featureArray=eval("("+featureJson+")"),coordinates=featureArray.geometry.coordinates.toString().split(","),poly={1:"",2:""},polyNum=1,polyRingPoint=[],pollLatLon=[],datelineCrosses=0,poly1HighLon=!0;for(var i=0,len=coordinates.length;i<len;i+=2){var lon=coordinates[i],lat=coordinates[i+1],nextLon=coordinates[i+2],nextLat=coordinates[i+3];if(lat==90&&nextLat==90||lat==-90&&nextLat==-90)if(lon==360&&nextLon==0||lon==0&&nextLon==360||lon==720&&nextLon==360||lon==0&&nextLon==-360)return wktString;i==0&&(polyRingPoint[polyNum]=","+lon+" "+lat);if(nextLon-lon>180||nextLon-lon<-180){datelineCrosses+=1;var newLat;if(projection!="cylindrical"){var equationLat=((nextLon-lon)*(lat-90)-(nextLat-lat)*lon)/(-180*(nextLon-lon));newLat=Number(lat)+Number(equationLat*(nextLat-lat))}else{lat/=1,lon/=1,nextLat/=1,nextLon/=1;if(lon>nextLon){var slope=(nextLat-lat)/(360+nextLon-lon);newLat=lat+slope*(360-lon)}else{var slope=(nextLat-lat)/(nextLon-(360+lon));newLat=lat+slope*(360-(360+lon))}}poly[polyNum]&&(poly[polyNum]=poly[polyNum]+","),poly[polyNum]=poly[polyNum]+lon+" "+lat,poly[polyNum]&&(poly[polyNum]=poly[polyNum]+","),nextLon-lon>180&&(datelineLon=0,poly[polyNum]=poly[polyNum]+datelineLon+" "+newLat,pollLatLon=projection=="north-polar stereographic"?{1:",0 90",2:",360 90"}:{1:",0 -90",2:",360 -90"},polyNum=polyNum==1?2:1),nextLon-lon<-180&&(datelineLon=360,poly[polyNum]=poly[polyNum]+datelineLon+" "+newLat,pollLatLon=projection=="north-polar stereographic"?{2:",0 90",1:",360 90"}:{2:",0 -90",1:",360 -90"},polyNum==1?polyNum=2:(polyNum=1,poly1HighLon=!1)),datelineLon=datelineLon==360?0:360,poly[polyNum]&&(poly[polyNum]=poly[polyNum]+","),poly[polyNum]=poly[polyNum]+datelineLon+" "+newLat,polyRingPoint[polyNum]=","+datelineLon+" "+newLat}else poly[polyNum]&&(poly[polyNum]=poly[polyNum]+","),poly[polyNum]=poly[polyNum]+lon+" "+lat}return poly[2]?datelineCrosses==1?(poly[1]+=pollLatLon[1]+pollLatLon[2]+","+poly[2],"MULTIPOLYGON((("+poly[1]+")))"):(poly[2]+=polyRingPoint[2],"MULTIPOLYGON((("+poly[1]+")),(("+poly[2]+")))"):"MULTIPOLYGON((("+poly[1]+")))"}if(wktPrefix=="LINESTRING"){if(!this.crossesDateline(wktString,projection))return wktString;var geojson=new OpenLayers.Format.GeoJSON,featureJson=geojson.write(wktParse.read(wktString)),featureArray=eval("("+featureJson+")"),coordinates=featureArray.geometry.coordinates.toString().split(","),normalizedWktArrayStr=[];normalizedWktArrayStr.push("LINESTRING(");var added=!1;for(i=0,len=coordinates.length;i<len;i+=2){var lon=coordinates[i],lat=coordinates[i+1],nextLon=coordinates[i+2],nextLat=coordinates[i+3];nextLon-lon>180||nextLon-lon<-180?(lon>nextLon?(normalizedWktArrayStr.push(lon+" "+lat+","),normalizedWktArrayStr.push(360+nextLon/1+" "+nextLat+",")):(normalizedWktArrayStr.push(360+lon/1+" "+lat+","),normalizedWktArrayStr.push(nextLon+" "+nextLat+",")),added=!0):(added||normalizedWktArrayStr.push(lon+" "+lat+","),added=!1)}var normalizedWkt=normalizedWktArrayStr.join("");normalizedWkt=normalizedWkt.substring(0,normalizedWkt.length-1),normalizedWkt+=")";var featureGeometry=wktParse.read(normalizedWkt).geometry,datelineFeatureGeometry=wktParse.read("LINESTRING(360 -90, 360 90)").geometry,splitGeos=featureGeometry.splitWith(datelineFeatureGeometry),splitGeometry=new OpenLayers.Geometry.MultiLineString(splitGeos),splitFeature=new OpenLayers.Feature.Vector(splitGeometry);return wktParse.write(splitFeature)}return wktString},AstroGeometry.datelineShift=function(e){var t=new ol.format.WKT,n=t.readGeometry(e),r=this.extractGeometryType(e),i=new ol.proj.Projection({code:"shift",units:"degrees"});ol.proj.addProjection(i),ol.proj.addCoordinateTransforms("EPSG:4326","shift",function(e){return AstroGeometry.transformDatelineShift(e)},function(e){return AstroGeometry.transformDatelineUnShift(e)});var s=[];switch(r){case"POLYGON":case"MULTIPOLYGON":r=="MULTIPOLYGON"?s=n.getPolygons():s[0]=n,shiftedGeometry=new ol.geom.MultiPolygon,pushFX="appendPolygon";break;case"LINESTRING":case"MULTILINESTRING":r=="MULTILINESTRING"?s=n.getLineStrings():s[0]=n,shiftedGeometry=new ol.geom.MultiLineString,pushFX="appendLineString";break;case"POINT":case"MULTIPOINT":r=="MULTIPOINT"?s=n.getPoints():s[0]=n,shiftedGeometry=new ol.geom.MultiPoint,pushFX="appendPoint"}var o=[];for(var u=0,a=s.length;u<a;u++){var f=s[u].clone(),l=s[u].clone();o.push(s[u]),shiftedGeometry[pushFX](s[u]),f=f.transform("EPSG:4326","shift"),o.push(f),shiftedGeometry[pushFX](f),l=l.transform("shift","EPSG:4326"),o.push(l),shiftedGeometry[pushFX](l)}return shiftedWKT=t.writeGeometry(shiftedGeometry),shiftedWKT},AstroGeometry.undangle=function(e){var t=new ol.format.WKT,n=t.readGeometry(e);return n=n.transform("EPSG:4326","undangle"),e=t.writeGeometry(n),e},AstroGeometry.transformCylindricalToLatLon=function(e){return e},AstroGeometry.transformLatLonToCylindrical=function(e){return e},AstroGeometry.transformTruncate=function(e){var t=2;return e[0]=e[0].toFixed(t),e[1]=e[1].toFixed(t),e},AstroGeometry.transformPolarMetersToLatLon=function(e,t,n){var r=n*1e3,i,s,o=e[0],u=e[1];switch(t){case"north-polar stereographic":i=90,s=Math.atan2(o,-u);break;case"south-polar stereographic":i=-90,s=Math.atan2(o,u)}var a=i*(Math.PI/180),f=Math.sqrt(Math.pow(o,2)+Math.pow(u,2)),l=2*Math.atan(f/(2*r)),c=Math.asin(Math.cos(l)*Math.sin(a)),h=c*180/Math.PI,p=s*180/Math.PI;return p<0&&(p+=360),e[0]=p,e[1]=h,e},AstroGeometry.transformLatLonToPolarMeters=function(e,t,n){var r=n*1e3,i=e[0],s=e[1],o=i*Math.PI/180,u=s*Math.PI/180;return t=="north-polar stereographic"?(e[0]=2*r*Math.tan(Math.PI/4-u/2)*Math.sin(o),e[1]=-2*r*Math.tan(Math.PI/4-u/2)*Math.cos(o)):(e[0]=2*r*Math.tan(Math.PI/4+u/2)*Math.sin(o),e[1]=2*r*Math.tan(Math.PI/4+u/2)*Math.cos(o)),e},AstroGeometry.transform180180To0360=function(e){var t=e[0];return t<0&&(e[0]=t+360),e},AstroGeometry.transform0360To180180=function(e){var t=e[0];return t>180&&(e[0]=t-360),e},AstroGeometry.transformDatelineShift=function(e){return e[0]=e[0]+360,e},AstroGeometry.transformDatelineUnShift=function(e){return e[0]=e[0]-360,e},AstroGeometry.transformDanglers=function(e){var t=e[0];while(t<0)t+=360;while(t>360)t-=360;return e[0]=t,e},AstroGeometry.transformPosEastPosWest=function(e){return e[0]=360-e[0],e},AstroGeometry.transformOcentricToOgraphic=function(e,t,n){var r=e[1]*Math.PI/180;return r=Math.atan(Math.tan(r)*(t/n)*(t/n)),r=r*180/Math.PI,e[1]=r,e},AstroGeometry.transformOgraphicToOcentric=function(e,t,n){var r=e[1]*Math.PI/180;return r=Math.atan(Math.tan(r)*(n/t)*(n/t)),r=r*180/Math.PI,e[1]=r,e},AstroGeometry.transformDecimalPlaces=function(e,t){return t||(t=2),e.x=Number(e.x).toFixed(t),e.y=Number(e.y).toFixed(t),e},AstroGeometry.LatLonToKM=function(e,t,n,r,i,s){typeof Number.prototype.toRad=="undefined"&&(Number.prototype.toRad=function(){return this*Math.PI/180});var o=i;b=s;var u=0,a=(r-t).toRad(),f=Math.atan((1-u)*Math.tan(e.toRad())),l=Math.atan((1-u)*Math.tan(n.toRad())),c=Math.sin(f),h=Math.cos(f),p=Math.sin(l),d=Math.cos(l),v=a,m,g=100;do{var y=Math.sin(v),w=Math.cos(v),E=Math.sqrt(d*y*d*y+(h*p-c*d*w)*(h*p-c*d*w));if(E==0)return 0;var S=c*p+h*d*w,x=Math.atan2(E,S),T=h*d*y/E,N=1-T*T,C=S-2*c*p/N;isNaN(C)&&(C=0);var k=u/16*N*(4+u*(4-3*N));m=v,v=a+(1-k)*u*T*(x+k*E*(C+k*S*(-1+2*C*C)))}while(Math.abs(v-m)>1e-12&&--g>0);if(g==0)return NaN;var L=N*(o*o-b*b)/(b*b),A=1+L/16384*(4096+L*(-768+L*(320-175*L))),O=L/1024*(256+L*(-128+L*(74-47*L))),M=O*E*(C+O/4*(S*(-1+2*C*C)-O/6*C*(-3+4*E*E)*(-3+4*C*C))),_=b*A*(x-M);return _=_.toFixed(3),_},AstroGeometry.getLengthOfLine=function(e,t,n,r){var i=0,s=e;if(r=="north-polar stereographic"||r=="south-polar stereographic"){var o=new OpenLayers.Format.WKT;o.internalProjection=new OpenLayers.Projection("EPSG:4326"),o.externalProjection=new OpenLayers.Projection(r),s=o.read(e.toString()).geometry}var u=s.getVertices(),a,f;if(u.length>1)for(var l=0;l<u.length-1;l++)a=u[l],f=u[l+1],i+=Number(this.LatLonToKM(a.y,a.x,f.y,f.x,t,n));return i},AstroGeometry.getAreaOfPolygon=function(e,t,n,r){if(r=="cylindrical"){var i=new OpenLayers.Format.WKT;i.internalProjection=new OpenLayers.Projection("north-polar-stereographic"),i.externalProjection=new OpenLayers.Projection("EPSG:4326"),newGeometry=i.read(e.toString()).geometry}},AstroGeometry.getSphericalAreaOfPolygon=function(e,t){var n=function(e){return(1-Math.Cos(e))/2},i=0,s=0,o=0,u=0,a=0,f=0,l=0,c=0;for(var h=0;h<lat.Length;h++){var p=h+1;h==0?(i=lon[h],o=lat[h],s=lon[h+1],u=lat[h+1],a=Math.Cos(o),f=Math.Cos(u)):(p=(h+1)%lat.Length,i=s,o=u,s=lon[p],u=lat[p],a=f,f=Math.Cos(u));if(i!=s){l=n(u-o)+a*f*n(s-i);var d=2*Math.Asin(Math.Sqrt(l)),v=Math.PI/2-u,m=
Math.PI/2-o,g=.5*(d+v+m),y=Math.Tan(g/2)*Math.Tan((g-d)/2)*Math.Tan((g-v)/2)*Math.Tan((g-m)/2),b=Math.Abs(4*Math.Atan(Math.Sqrt(Math.Abs(y))));s<i&&(b=-b),c+=b}}return Math.Abs(c)*r*r},window.astro={};var astro=window.astro;astro.ScaleLine=function(){this.minWidth_=64,this.caxis=0,this.LEADING_DIGITS=[1,2,5],ol.control.ScaleLine.call(this);var e={},t="ol-scale-line";this.element=document.createElement("div"),this.element.className=t,this.element.className+=" ol-unselectable",this.innerElement_=document.createElement("div"),this.innerElement_.className=t+"-inner",this.element.appendChild(this.innerElement_)},ol.inherits(astro.ScaleLine,ol.control.ScaleLine),ol.control.ScaleLineUnits={DEGREES:"degrees",IMPERIAL:"imperial",NAUTICAL:"nautical",METRIC:"metric",US:"us"},ol.control.ScaleLine.LEADING_DIGITS=[1,2,5],astro.ScaleLine.prototype.updateElementAstro=function(){var e=this.viewState_;if(!e){this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1);return}var t=e.center,n=e.projection,r=this.getUnits(),i=n.getUnits();pointResolution=e.resolution,i!="degrees"?pointResolution*=n.getMetersPerUnit():(cosLatitude=Math.cos(this.toRadians(t[1])),pointResolution*=Math.PI*cosLatitude*this.caxis/180);var s=this.minWidth_*pointResolution,o="";if(r==ol.control.ScaleLineUnits.DEGREES){var u=ol.proj.METERS_PER_UNIT[ol.proj.Units.DEGREES];n.getUnits()==ol.proj.Units.DEGREES?s*=u:pointResolution/=u,s<u/60?(o="″",pointResolution*=3600):s<u?(o="′",pointResolution*=60):o="°"}else r==ol.control.ScaleLineUnits.IMPERIAL?s<.9144?(o="in",pointResolution/=.0254):s<1609.344?(o="ft",pointResolution/=.3048):(o="mi",pointResolution/=1609.344):r==ol.control.ScaleLineUnits.NAUTICAL?(pointResolution/=1852,o="nm"):r==ol.control.ScaleLineUnits.METRIC?s<.001?(o="μm",pointResolution*=1e6):s<1?(o="mm",pointResolution*=1e3):s<1e3?o="m":(o="km",pointResolution/=1e3):r==ol.control.ScaleLineUnits.US?s<.9144?(o="in",pointResolution*=39.37):s<1609.344?(o="ft",pointResolution/=.30480061):(o="mi",pointResolution/=1609.3472):ol.asserts.assert(!1,33);var a=3*Math.floor(Math.log(this.minWidth_*pointResolution)/Math.log(10)),f,l;for(;;){f=ol.control.ScaleLine.LEADING_DIGITS[(a%3+3)%3]*Math.pow(10,Math.floor(a/3)),l=Math.round(f/pointResolution);if(isNaN(l)){this.element_.style.display="none",this.renderedVisible_=!1;return}if(l>=this.minWidth_)break;++a}var c=f+" "+o;this.renderedHTML_!=c&&(this.innerElement_.innerHTML=c,this.renderedHTML_=c),this.renderedWidth_!=l&&(this.innerElement_.style.width=l+"px",this.renderedWidth_=l),!this.renderedVisible_&&this.element_&&(this.element_.style.display="",this.renderedVisible_=!0)},astro.ScaleLine.prototype.setRadius=function(e){this.caxis=e},astro.ScaleLine.prototype.toRadians=function(e){return e*Math.PI/180},astro.ScaleLine.prototype.writeToCanvas=function(){var e=$("canvas").get(0),t=$(".ol-scale-line-inner"),n=6,r=10,i=30,s=15,o=s+"px Arial",u=1,a=e.getContext("2d"),f=parseInt(t.css("width"),10)*u,l=t.text(),c=parseInt(l,10)*u,h=l.match(/[Aa-zZ]{1,}/g);a.beginPath(),a.textAlign="left",a.strokeStyle="#ffffff",a.fillStyle="#000000",a.lineWidth=5,a.font=o,a.strokeText([c+" "+h],r+s/2,e.height-i-s/2),a.fillText([c+" "+h],r+s/2,e.height-i-s/2);var p=f+r,d=e.height-i,v=r+f*1/4,m=v+f*1/4,g=m+f*1/4,y=g+f*1/4;a.beginPath(),a.lineWidth=n+2,a.strokeStyle="#000000",a.fillStyle="#ffffff",a.moveTo(r,d),a.lineTo(p+1,d),a.stroke(),a.beginPath(),a.lineWidth=n,a.strokeStyle="#000000",a.moveTo(r,d),a.lineTo(v,d),a.stroke(),a.beginPath(),a.lineWidth=n,a.strokeStyle="#FFFFFF",a.moveTo(v,d),a.lineTo(m,d),a.stroke(),a.beginPath(),a.lineWidth=n,a.strokeStyle="#000000",a.moveTo(m,d),a.lineTo(g,d),a.stroke(),a.beginPath(),a.lineWidth=n,a.strokeStyle="#FFFFFF",a.moveTo(g,d),a.lineTo(y,d),a.stroke()},olLayerSwitcherHook=function(e){},function(e,t){typeof exports=="object"&&typeof module!="undefined"?module.exports=t(require("ol/control/control"),require("ol/observable")):typeof define=="function"&&define.amd?define(["ol/control/control","ol/observable"],t):e.LayerSwitcher=t(e.ol.control.Control,e.ol.Observable)}(this,function(e,t){"use strict";e="default"in e?e["default"]:e,t="default"in t?t["default"]:t;var n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function a(e,t,n){e===null&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(r===undefined){var i=Object.getPrototypeOf(e);return i===null?undefined:a(i,t,n)}if("value"in r)return r.value;var s=r.get;return s===undefined?undefined:s.call(n)},s=function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||typeof t!="object"&&typeof t!="function"?e:t},u=function(e){function u(e){n(this,u);var t=e||{},r=t.tipLabel?t.tipLabel:"Legend",i=t.graticule?t.graticule:!1,s=document.createElement("div"),a=o(this,(u.__proto__||Object.getPrototypeOf(u)).call(this,{element:s,target:t.target}));a.mapListeners=[],a.graticule=i,a.astroMap=t.astroMap,a.hiddenClassName="ol-unselectable ol-control layer-switcher",u.isTouchDevice_()&&(a.hiddenClassName+=" touch"),a.shownClassName="shown",s.className=a.hiddenClassName;var f=document.createElement("button");f.setAttribute("title",r),s.appendChild(f),a.panel=document.createElement("div"),a.panel.className="panel",s.appendChild(a.panel),u.enableTouchScroll_(a.panel);var l=a;return f.onmouseover=function(e){l.showPanel()},f.onclick=function(e){e=e||window.event,l.showPanel(),e.preventDefault()},l.panel.onmouseout=function(e){e=e||window.event,l.panel.contains(e.toElement||e.relatedTarget)||l.hidePanel()},a}return s(u,e),r(u,[{key:"setMap",value:function(n){for(var r=0,s;r<this.mapListeners.length;r++)t.unByKey(this.mapListeners[r]);this.mapListeners.length=0,i(u.prototype.__proto__||Object.getPrototypeOf(u.prototype),"setMap",this).call(this,n);if(n){var o=this;this.mapListeners.push(n.on("pointerdown",function(){o.hidePanel()})),this.renderPanel()}}},{key:"showPanel",value:function(){this.element.classList.contains(this.shownClassName)||(this.element.classList.add(this.shownClassName),this.renderPanel())}},{key:"hidePanel",value:function(){this.element.classList.contains(this.shownClassName)&&this.element.classList.remove(this.shownClassName)}},{key:"renderPanel",value:function(){var t=this;this.ensureTopVisibleBaseLayerShown_();while(this.panel.firstChild)this.panel.removeChild(this.panel.firstChild);var n=document.createElement("ul");this.panel.appendChild(n),this.renderLayers_(this.getMap(),n);if(this.graticule){var r=document.getElementById("ul_Overlays");if(!r){var i=document.createElement("li"),s=document.createElement("label");i.className="group",s.innerHTML="Overlays",i.appendChild(s),r=document.createElement("ul"),r.id="ul_Overlays",i.appendChild(r),n.insertBefore(i,n.childNodes[0])}var o=document.createElement("li"),u=document.createElement("input"),a=document.createElement("label");a.innerHTML="Graticule",u.type="checkbox",u.checked=!0,u.onchange=function(e){var n=t.astroMap.controls.graticule.getMap();n?t.astroMap.controls.graticule.setMap(null):t.astroMap.controls.graticule.setMap(t.astroMap.map)},r.insertBefore(o,r.childNodes[0]),o.appendChild(u),o.appendChild(a)}}},{key:"ensureTopVisibleBaseLayerShown_",value:function(){var t;u.forEachRecursive(this.getMap(),function(e,n,r){e.get("type")==="base"&&e.getVisible()&&(t=e)}),t&&this.setVisible_(t,!0)}},{key:"setVisible_",value:function(t,n){var r=this.getMap();t.setVisible(n),n&&t.get("type")==="base"&&u.forEachRecursive(r,function(e,n,r){e!=t&&e.get("type")==="base"&&e.setVisible(!1)})}},{key:"renderLayer_",value:function(t,n){var r=this,i=document.createElement("li"),s=t.get("title"),o=u.uuid(),a=document.createElement("label");if(t.getLayers&&!t.get("combine")){i.className="group",a.innerHTML=s,i.appendChild(a);var f=document.createElement("ul");f.id="ul_"+s,i.appendChild(f),this.renderLayers_(t,f)}else{i.className="layer";var l=document.createElement("div");l.className="truncate";var c=document.createElement("input"),h=document.createElement("input");t.get("type")==="base"?(c.type="radio",c.name="base"):c.type="checkbox",c.id=o,c.checked=t.get("visible"),c.onchange=function(e){r.setVisible_(t,e.target.checked),olLayerSwitcherHook(t)},l.appendChild(c),a.htmlFor=o;var p=30;a.innerHTML=s.length>p?s.substring(0,25)+"...":s,a.innerHTML=s;var d=this.getMap().getView().getResolution();if(d>t.getMaxResolution()||d<t.getMinResolution())a.className+=" disabled";l.appendChild(a),i.appendChild(l),t.get("enableOpacitySliders")&&(h.type="range",h.className="opacity",h.min=0,h.max=1,h.step=.01,h.value=t.getOpacity(),h.onchange=function(e){t.setOpacity(e.target.value),r.onOpacityChange!==null&&typeof r.onOpacityChange=="function"&&r.onOpacityChange(e.target.value,t)},i.appendChild(h))}return i}},{key:"renderLayers_",value:function(t,n){var r=t.getLayers().getArray().slice().reverse();for(var i=0,s;i<r.length;i++)s=r[i],s.get("title")&&n.appendChild(this.renderLayer_(s,i))}}],[{key:"forEachRecursive",value:function(t,n){t.getLayers().forEach(function(e,t,r){n(e,t,r),e.getLayers&&u.forEachRecursive(e,n)})}},{key:"uuid",value:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}},{key:"enableTouchScroll_",value:function(t){if(u.isTouchDevice_()){var n=0;t.addEventListener("touchstart",function(e){n=this.scrollTop+e.touches[0].pageY},!1),t.addEventListener("touchmove",function(e){this.scrollTop=n-e.touches[0].pageY},!1)}}},{key:"isTouchDevice_",value:function(){try{return document.createEvent("TouchEvent"),!0}catch(t){return!1}}}]),u}(e);return window.ol&&window.ol.control&&(window.ol.control.LayerSwitcher=u),u});